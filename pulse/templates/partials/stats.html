<!-- Row 1: Health Bar -->
<div class="health-bar">
    <div class="health-dots">
        {% for name, status in processing.items() %}
        <div class="health-dot {{ 'active' if status.article_id else '' }}" title="{{ name }}">
            <div class="tooltip">
                <strong>{{ name }}</strong>
                {% if avg_times.get(name) is not none %}<br>avg {{ avg_times[name] }}s{% endif %}
            </div>
        </div>
        {% endfor %}
    </div>
    <div class="health-stats">
        <span class="health-stat">Queue <strong>{{ stats.impact_unscored }}</strong></span>
        <span class="health-stat">Relevant <strong>{{ stats.impact_relevant }}</strong></span>
        <span class="health-stat">Mentions <strong>{{ stats.company_mentions }}</strong></span>
        <span class="health-stat">Sent <strong>{{ stats.sent_articles }}</strong></span>
    </div>
</div>

<!-- Row 2: Two columns -->
<div class="dash-columns">
    <!-- Left column -->
    <div>
        <!-- Pipeline Flow -->
        <div class="dash-card">
            <h3>Pipeline Flow</h3>
            <div class="pipeline">
                <div class="pipeline-stage">
                    <span class="count">{{ stats.total_articles }}</span>
                    Ingested
                </div>
                <span class="pipeline-arrow">&rarr;</span>
                <div class="pipeline-stage">
                    <span class="count">{{ stats.impact_scored }}</span>
                    Impact Scored
                </div>
                <span class="pipeline-arrow">&rarr;</span>
                <div class="pipeline-stage">
                    <span class="count">{{ stats.impact_relevant }}</span>
                    Relevant
                </div>
                <span class="pipeline-arrow">&rarr;</span>
                <div class="pipeline-stage">
                    <span class="count">{{ stats.processed_articles }}</span>
                    NLI Classified
                </div>
                <span class="pipeline-arrow">&rarr;</span>
                <div class="pipeline-stage">
                    <span class="count">{{ stats.company_scanned }}</span>
                    Co. Scanned
                </div>
                <span class="pipeline-arrow">&rarr;</span>
                <div class="pipeline-stage">
                    <span class="count">{{ stats.sent_articles }}</span>
                    Sent
                </div>
            </div>
        </div>

        <!-- Recent Articles -->
        <div class="dash-card">
            <h3>Recent Articles</h3>
            {% if recent_articles %}
            <table class="recent-table">
                <thead>
                    <tr>
                        <th>Article</th>
                        <th>Date</th>
                        <th>Impact</th>
                        <th>Sent</th>
                    </tr>
                </thead>
                <tbody>
                {% for a in recent_articles %}
                <tr>
                    <td>
                        <a href="/articles/{{ a.id }}">
                            {{ a.title if a.title else a.url[:60] }}
                        </a>
                    </td>
                    <td>{{ a.published_at[:10] if a.published_at else (a.fetched_at[:10] if a.fetched_at else '-') }}</td>
                    <td>
                        {% if a.impact is not none %}
                            <span class="{{ 'impact-hi' if a.impact >= 0.5 else 'impact-lo' }}">
                                {{ '%.2f'|format(a.impact) }}
                            </span>
                        {% else %}
                            <span class="impact-lo">-</span>
                        {% endif %}
                    </td>
                    <td>
                        {% if a.sent_to_sentinel %}
                            <span class="badge badge-green">sent</span>
                        {% else %}
                            <span class="badge badge-dim">no</span>
                        {% endif %}
                    </td>
                </tr>
                {% endfor %}
                </tbody>
            </table>
            {% else %}
            <div class="empty">No articles yet</div>
            {% endif %}
        </div>
    </div>

    <!-- Right column -->
    <div>
        <!-- Workers -->
        <div class="dash-card">
            <h3>Workers</h3>
            {% for name, status in processing.items() %}
            <div class="worker-row">
                <div class="worker-dot {{ 'active' if status.article_id else '' }}"></div>
                <span class="worker-name">{{ name }}</span>
                <span class="worker-activity">
                    {% if status.article_id %}
                        #{{ status.article_id }}
                        <span class="elapsed-timer" data-started="{{ status.started_at }}"></span>
                    {% else %}
                        idle
                    {% endif %}
                </span>
                {% if avg_times.get(name) is not none %}
                <span class="worker-avg">avg {{ avg_times[name] }}s</span>
                {% endif %}
            </div>
            {% endfor %}
        </div>

        <!-- Model Results -->
        {% if stats.per_model %}
        <div class="dash-card">
            <h3>Model Results</h3>
            {% for model, count in stats.per_model.items() %}
            <div class="model-row">
                <span class="kv-label">{{ model }}</span>
                <span class="kv-value">{{ count }}</span>
            </div>
            {% endfor %}
        </div>
        {% endif %}

        <!-- Counts -->
        <div class="dash-card">
            <h3>Counts</h3>
            <div class="kv-row">
                <span class="kv-label">Total Articles</span>
                <span class="kv-value">{{ stats.total_articles }}</span>
            </div>
            <div class="kv-row">
                <span class="kv-label">Feeds</span>
                <span class="kv-value">{{ stats.total_feeds }}</span>
            </div>
            <div class="kv-row">
                <span class="kv-label">Unscored</span>
                <span class="kv-value">{{ stats.impact_unscored }}</span>
            </div>
            <div class="kv-row">
                <span class="kv-label">Company Mentions</span>
                <span class="kv-value">{{ stats.company_mentions }}</span>
            </div>
            <div class="kv-row">
                <span class="kv-label">Sentiment Scored</span>
                <span class="kv-value">{{ stats.company_scored }}</span>
            </div>
        </div>
    </div>
</div>

<!-- Elapsed timer updater -->
<script>
(function() {
    function updateTimers() {
        document.querySelectorAll('.elapsed-timer').forEach(function(el) {
            var started = parseFloat(el.dataset.started);
            if (!started) return;
            var elapsed = Math.floor(Date.now() / 1000 - started);
            if (elapsed < 0) elapsed = 0;
            var m = Math.floor(elapsed / 60);
            var s = elapsed % 60;
            el.textContent = (m > 0 ? m + 'm ' : '') + s + 's';
        });
    }
    updateTimers();
    setInterval(updateTimers, 1000);
})();
</script>
