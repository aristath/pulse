<!-- Row 1: Health Bar -->
<div class="health-bar">
    <div class="health-dots">
        {% for name, status in processing.items() %}
        <div class="health-dot {{ 'active' if status.article_id else '' }}" title="{{ worker_labels.get(name, name) }}"{% if status.started_at %} data-started="{{ status.started_at }}"{% endif %}>
            <div class="tooltip">
                <strong>{{ worker_labels.get(name, name) }}</strong>
                {% if avg_times.get(name) is not none %}<br>avg {{ avg_times[name] }}s{% endif %}
            </div>
        </div>
        {% endfor %}
    </div>
    <div class="health-stats">
        <span class="health-stat">Queue <strong>{{ stats.impact_unscored }}</strong></span>
        <span class="health-stat">Relevant <strong>{{ stats.impact_relevant }}</strong></span>
        <span class="health-stat">Mentions <strong>{{ stats.company_mentions }}</strong></span>
        <span class="health-stat">Sent <strong>{{ stats.sent_articles }}</strong></span>
    </div>
</div>

<!-- Row 2: Two columns -->
<div class="dash-columns">
    <!-- Left column -->
    <div>
        <!-- Pipeline Flow -->
        <div class="dash-card">
            <h3>Pipeline Flow</h3>
            <div class="pipeline">
                <div class="pipeline-stage">
                    <span class="count">{{ stats.total_articles }}</span>
                    Ingested
                </div>
                <span class="pipeline-arrow">&rarr;</span>
                <div class="pipeline-stage">
                    <span class="count">{{ stats.impact_scored }}</span>
                    Impact Scored
                </div>
                <span class="pipeline-arrow">&rarr;</span>
                <div class="pipeline-stage">
                    <span class="count">{{ stats.impact_relevant }}</span>
                    Relevant
                </div>
                <span class="pipeline-arrow">&rarr;</span>
                <div class="pipeline-stage">
                    <span class="count">{{ stats.processed_articles }}</span>
                    NLI Classified
                </div>
                <span class="pipeline-arrow">&rarr;</span>
                <div class="pipeline-stage">
                    <span class="count">{{ stats.company_scanned }}</span>
                    Co. Scanned
                </div>
                <span class="pipeline-arrow">&rarr;</span>
                <div class="pipeline-stage">
                    <span class="count">{{ stats.sent_articles }}</span>
                    Sent
                </div>
            </div>
        </div>

        <!-- Charts (preserved across HTMX swaps) -->
        <div id="charts-card" class="dash-card" hx-preserve="true">
            <h3>Sentiment by Country (30-day decay-weighted)</h3>
            <div id="chart-country-bars" style="width:100%;height:300px;"></div>

            <h3 style="margin-top:1.5rem;">Sentiment by Industry (30-day decay-weighted)</h3>
            <div id="chart-industry-bars" style="width:100%;height:300px;"></div>

            <h3 style="margin-top:1.5rem;">Sentiment by Company (30-day decay-weighted)</h3>
            <div id="chart-company-bars" style="width:100%;height:300px;"></div>

            <h3 style="margin-top:1.5rem;">Impact Distribution</h3>
            <div id="chart-impact-dist" style="width:100%;height:250px;"></div>
        </div>

        <!-- Feeds (collapsible, preserved across HTMX swaps) -->
        <details id="feeds-section" class="collapsible-section" hx-preserve="true">
            <summary>Feeds ({{ feeds|length }})</summary>
            <div class="collapsible-body">
                <form hx-post="/api/feeds" hx-target="#feeds-list" hx-swap="outerHTML"
                      hx-on::after-request="this.reset(); htmx.ajax('GET', '/partials/feeds', '#feeds-list')">
                    <div class="form-row">
                        <input type="url" name="url" placeholder="https://example.com/rss" required>
                        <input type="text" name="name" placeholder="Name (optional)" style="max-width: 200px;">
                        <button type="submit" class="btn btn-primary btn-sm">Add</button>
                    </div>
                </form>
                <div id="feeds-list">
                    {% include "partials/feeds_list.html" %}
                </div>
            </div>
        </details>

        <!-- Settings (collapsible, preserved across HTMX swaps) -->
        <details id="settings-section" class="collapsible-section" hx-preserve="true">
            <summary>Settings</summary>
            <div class="collapsible-body">
                <div class="settings-group">
                    <h4>Sentinel Connection</h4>
                    <form hx-put="/api/settings/sentinel_url" hx-swap="none"
                          hx-on::after-request="document.getElementById('save-status').textContent = 'Saved'; setTimeout(() => document.getElementById('save-status').textContent = '', 2000)">
                        <div class="form-row">
                            <input type="url" name="url" value="{{ sentinel_url }}" placeholder="http://192.168.1.x:8000">
                            <button type="submit" class="btn btn-primary btn-sm">Save</button>
                            <span id="save-status" style="color: var(--green); font-size: 0.8rem;"></span>
                        </div>
                    </form>
                </div>

                <div class="settings-group">
                    <h4>NLI Prompts</h4>
                    <form hx-put="/api/settings/prompts" hx-swap="none"
                          hx-on::after-request="document.getElementById('prompt-status').textContent = 'Saved'; setTimeout(() => document.getElementById('prompt-status').textContent = '', 2000)">
                        <div class="settings-field">
                            <label>Impact / Relevance</label>
                            <input type="text" name="prompt_impact" value="{{ prompt_impact }}" placeholder="This text is about business or economics.">
                        </div>
                        <div class="settings-field">
                            <label>Country Relevance <code>{country}</code></label>
                            <input type="text" name="prompt_country" value="{{ prompt_country }}" placeholder="This article is about {country}.">
                        </div>
                        <div class="settings-field">
                            <label>Sector Sentiment <code>{sector} {country}</code></label>
                            <input type="text" name="prompt_sentiment" value="{{ prompt_sentiment }}" placeholder="This is good news for the {sector} sector in {country}.">
                        </div>
                        <div class="settings-field">
                            <label>Company Sentiment <code>{company}</code></label>
                            <input type="text" name="prompt_company" value="{{ prompt_company }}" placeholder="This is good news for {company}.">
                        </div>
                        <div class="form-row">
                            <button type="submit" class="btn btn-primary btn-sm">Save Prompts</button>
                            <span id="prompt-status" style="color: var(--green); font-size: 0.8rem;"></span>
                        </div>
                    </form>
                </div>

                <div class="settings-group">
                    <h4>Thresholds</h4>
                    <form hx-put="/api/settings/thresholds" hx-swap="none"
                          hx-on::after-request="document.getElementById('threshold-status').textContent = 'Saved'; setTimeout(() => document.getElementById('threshold-status').textContent = '', 2000)">
                        <div class="settings-field">
                            <label>Classify (impact &ge;)</label>
                            <input type="number" name="classify_threshold" value="{{ classify_threshold }}" placeholder="0.5" step="0.01" min="0" max="1" style="max-width:100px;">
                        </div>
                        <div class="settings-field">
                            <label>Company Scanner (impact &ge;)</label>
                            <input type="number" name="scan_threshold" value="{{ scan_threshold }}" placeholder="0.3" step="0.01" min="0" max="1" style="max-width:100px;">
                        </div>
                        <div class="settings-field">
                            <label>Validate Company (entailment &ge;)</label>
                            <input type="number" name="validate_threshold" value="{{ validate_threshold }}" placeholder="0.5" step="0.01" min="0" max="1" style="max-width:100px;">
                        </div>
                        <div class="form-row">
                            <button type="submit" class="btn btn-primary btn-sm">Save Thresholds</button>
                            <span id="threshold-status" style="color: var(--green); font-size: 0.8rem;"></span>
                        </div>
                    </form>
                </div>

                <div class="settings-group">
                    <h4>Fundus Publishers</h4>
                    <div id="fundus-publishers">
                        <p style="color: var(--text-dim); font-size: 0.8rem;">Loading publishers...</p>
                    </div>
                    <div class="form-row" style="margin-top: 0.5rem;">
                        <button class="btn btn-primary btn-sm" onclick="saveFundusPublishers()">Save</button>
                        <button class="btn btn-sm" style="background: var(--green); color: white;" onclick="triggerFundusCrawl(this)">Crawl Now</button>
                        <span id="fundus-status" style="color: var(--green); font-size: 0.8rem;"></span>
                    </div>
                </div>
            </div>
        </details>
    </div>

    <!-- Right column -->
    <div>
        <!-- Workers -->
        <div class="dash-card">
            <h3>Workers</h3>
            {% for name, status in processing.items() %}
            <div class="worker-row">
                <div class="worker-dot {{ 'active' if status.article_id else '' }}"{% if status.started_at %} data-started="{{ status.started_at }}"{% endif %}></div>
                <span class="worker-name">{{ worker_labels.get(name, name) }}</span>
                <span class="worker-activity">
                    {% if status.article_id %}
                        #{{ status.article_id }}
                        <span class="elapsed-timer" data-started="{{ status.started_at }}"></span>
                    {% else %}
                        idle
                    {% endif %}
                </span>
                {% if avg_times.get(name) is not none %}
                <span class="worker-avg">avg {{ avg_times[name] }}s</span>
                {% endif %}
            </div>
            {% endfor %}
        </div>

    </div>
</div>

<!-- Elapsed timer updater + settings JS -->
<script>
(function() {
    function updateTimers() {
        document.querySelectorAll('.elapsed-timer').forEach(function(el) {
            var started = parseFloat(el.dataset.started);
            if (!started) return;
            var elapsed = Math.floor(Date.now() / 1000 - started);
            if (elapsed < 0) elapsed = 0;
            var m = Math.floor(elapsed / 60);
            var s = elapsed % 60;
            el.textContent = (m > 0 ? m + 'm ' : '') + s + 's';
        });
    }
    updateTimers();
    setInterval(updateTimers, 1000);

    // Offset blink animation so each dot starts from its job start time
    document.querySelectorAll('.health-dot[data-started], .worker-dot[data-started]').forEach(function(el) {
        var started = parseFloat(el.dataset.started);
        if (!started) return;
        var elapsed = (Date.now() / 1000 - started) % 0.25;
        el.style.animationDelay = '-' + elapsed.toFixed(3) + 's';
    });

    // Init echarts (only once)
    if (typeof echarts !== 'undefined' && !window._chartsInited) {
        window._chartsInited = true;
        var allCharts = [];

        // Impact distribution chart
        var distChart = echarts.init(document.getElementById('chart-impact-dist'));
        distChart.setOption({
            backgroundColor: 'transparent',
            textStyle: { color: '#e0e0e8', fontSize: 11 },
            tooltip: {
                trigger: 'axis',
                backgroundColor: '#12121a',
                borderColor: '#1e1e2e',
                textStyle: { color: '#e0e0e8', fontSize: 11 },
                formatter: function(params) {
                    var p = params[0];
                    return 'Impact: ' + p.name + '<br>Articles: ' + p.value;
                }
            },
            grid: { top: 10, left: 50, right: 10, bottom: 30 },
            xAxis: {
                type: 'category',
                axisLine: { lineStyle: { color: '#1e1e2e' } },
                axisLabel: { color: '#8888a0', fontSize: 10 }
            },
            yAxis: {
                type: 'log',
                min: 1,
                axisLine: { lineStyle: { color: '#1e1e2e' } },
                axisLabel: { color: '#8888a0', fontSize: 10 },
                splitLine: { lineStyle: { color: '#1e1e2e' } }
            },
            series: []
        });
        allCharts.push(distChart);

        function refreshDistChart() {
            fetch('/api/charts/impact-distribution').then(function(r) { return r.json(); }).then(function(data) {
                distChart.setOption({
                    xAxis: { data: data.map(function(d) { return d.bucket.toFixed(2); }) },
                    series: [{
                        type: 'bar',
                        data: data.map(function(d) { return d.count; }),
                        color: '#6366f1',
                        barMaxWidth: 20
                    }]
                });
            });
        }
        refreshDistChart();
        setInterval(refreshDistChart, 30000);

        // Sentiment bar charts
        var countryBarChart = echarts.init(document.getElementById('chart-country-bars'));
        var industryBarChart = echarts.init(document.getElementById('chart-industry-bars'));
        var companyBarChart = echarts.init(document.getElementById('chart-company-bars'));
        allCharts.push(countryBarChart, industryBarChart, companyBarChart);

        function renderBarChart(chart, data) {
            var labels = data.map(function(d) { return d.label; });
            var values = data.map(function(d) { return d.avg_sentiment; });
            var colors = values.map(function(v) { return v >= 0 ? '#22c55e' : '#ef4444'; });
            chart.setOption({
                backgroundColor: 'transparent',
                textStyle: { color: '#e0e0e8', fontSize: 11 },
                tooltip: {
                    trigger: 'axis',
                    backgroundColor: '#12121a',
                    borderColor: '#1e1e2e',
                    textStyle: { color: '#e0e0e8', fontSize: 11 },
                    formatter: function(params) {
                        var p = params[0];
                        var idx = p.dataIndex;
                        var d = data[idx];
                        return d.label + '<br>Sentiment: ' + d.avg_sentiment.toFixed(4) + '<br>Articles: ' + d.article_count;
                    }
                },
                grid: { top: 10, left: 100, right: 10, bottom: 20 },
                yAxis: {
                    type: 'category',
                    data: labels,
                    inverse: true,
                    axisLine: { lineStyle: { color: '#1e1e2e' } },
                    axisLabel: { color: '#8888a0', fontSize: 10 }
                },
                xAxis: {
                    type: 'value',
                    min: -1, max: 1,
                    axisLine: { lineStyle: { color: '#1e1e2e' } },
                    axisLabel: { color: '#8888a0', fontSize: 10 },
                    splitLine: { lineStyle: { color: '#1e1e2e' } }
                },
                series: [{
                    type: 'bar',
                    data: values.map(function(v, i) {
                        return { value: v, itemStyle: { color: colors[i] } };
                    }),
                    barMaxWidth: 40
                }]
            });
        }

        function refreshBarCharts() {
            Promise.all([
                fetch('/api/charts/sentiment-bars?type=country').then(function(r) { return r.json(); }),
                fetch('/api/charts/sentiment-bars?type=industry').then(function(r) { return r.json(); }),
                fetch('/api/charts/sentiment-bars?type=company').then(function(r) { return r.json(); })
            ]).then(function(results) {
                renderBarChart(countryBarChart, results[0]);
                renderBarChart(industryBarChart, results[1]);
                renderBarChart(companyBarChart, results[2]);
            }).catch(function(e) { console.error('Bar chart refresh failed:', e); });
        }

        refreshBarCharts();
        setInterval(refreshBarCharts, 30000);
        window.addEventListener('resize', function() {
            allCharts.forEach(function(c) { c.resize(); });
        });
    }

    // Load fundus publishers (only if container exists and empty)
    var fp = document.getElementById('fundus-publishers');
    if (fp && !fp.dataset.loaded) {
        fp.dataset.loaded = '1';
        fetch('/api/fundus/publishers')
            .then(function(r) { return r.json(); })
            .then(function(data) {
                var countries = Object.keys(data).sort();
                if (!countries.length) {
                    fp.innerHTML = '<p style="color:var(--text-dim);font-size:0.8rem">No publishers available.</p>';
                    return;
                }
                var html = '';
                for (var i = 0; i < countries.length; i++) {
                    var country = countries[i];
                    var pubs = data[country];
                    var enabled = pubs.filter(function(p) { return p.enabled; }).length;
                    var countLabel = enabled > 0 ? enabled + '/' + pubs.length + ' enabled' : '' + pubs.length;
                    html += '<div class="fundus-country">';
                    html += '<div class="fundus-country-header" onclick="toggleCountry(this)">';
                    html += '<span class="arrow">&#9654;</span>';
                    html += '<span>' + country.toUpperCase() + '</span>';
                    html += '<span class="count">(' + countLabel + ')</span>';
                    html += '</div>';
                    html += '<div class="fundus-publishers-list">';
                    for (var j = 0; j < pubs.length; j++) {
                        var pub = pubs[j];
                        html += '<label class="fundus-pub-row">';
                        html += '<input type="checkbox" value="' + pub.id + '"' + (pub.enabled ? ' checked' : '') + '>';
                        html += '<span>' + pub.name + '</span>';
                        html += '<span class="domain">' + pub.domain + '</span>';
                        html += '</label>';
                    }
                    html += '</div></div>';
                }
                fp.innerHTML = html;
            })
            .catch(function() {
                fp.innerHTML = '<p style="color:var(--red);font-size:0.8rem">Failed to load publishers.</p>';
            });
    }
})();

function toggleCountry(header) {
    var arrow = header.querySelector('.arrow');
    var list = header.nextElementSibling;
    arrow.classList.toggle('open');
    list.classList.toggle('open');
}

function saveFundusPublishers() {
    var checks = document.querySelectorAll('#fundus-publishers input[type="checkbox"]:checked');
    var ids = Array.from(checks).map(function(c) { return c.value; });
    fetch('/api/fundus/publishers', {
        method: 'PUT',
        headers: {'Content-Type': 'application/json'},
        body: JSON.stringify({publishers: ids})
    }).then(function(r) { return r.json(); }).then(function() {
        var el = document.getElementById('fundus-status');
        el.textContent = 'Saved';
        setTimeout(function() { el.textContent = ''; }, 2000);
    });
}

function triggerFundusCrawl(btn) {
    btn.disabled = true;
    btn.textContent = 'Crawling...';
    fetch('/api/fundus/crawl', {method: 'POST'})
        .then(function(r) { return r.json(); })
        .then(function(data) {
            var el = document.getElementById('fundus-status');
            el.textContent = 'Done: ' + data.added + ' new';
            setTimeout(function() { el.textContent = ''; }, 5000);
        })
        .catch(function() {
            document.getElementById('fundus-status').textContent = 'Failed';
        })
        .finally(function() {
            btn.disabled = false;
            btn.textContent = 'Crawl Now';
        });
}
</script>
