<!-- Row 1: Health Bar -->
<div class="health-bar">
    <div class="health-dots">
        {% for name, status in processing.items() %}
        <div class="health-dot {{ 'active' if status.article_id else '' }}" title="{{ name }}">
            <div class="tooltip">
                <strong>{{ name }}</strong>
                {% if avg_times.get(name) is not none %}<br>avg {{ avg_times[name] }}s{% endif %}
            </div>
        </div>
        {% endfor %}
    </div>
    <div class="health-stats">
        <span class="health-stat">Queue <strong>{{ stats.impact_unscored }}</strong></span>
        <span class="health-stat">Relevant <strong>{{ stats.impact_relevant }}</strong></span>
        <span class="health-stat">Mentions <strong>{{ stats.company_mentions }}</strong></span>
        <span class="health-stat">Sent <strong>{{ stats.sent_articles }}</strong></span>
    </div>
</div>

<!-- Row 2: Two columns -->
<div class="dash-columns">
    <!-- Left column -->
    <div>
        <!-- Pipeline Flow -->
        <div class="dash-card">
            <h3>Pipeline Flow</h3>
            <div class="pipeline">
                <div class="pipeline-stage">
                    <span class="count">{{ stats.total_articles }}</span>
                    Ingested
                </div>
                <span class="pipeline-arrow">&rarr;</span>
                <div class="pipeline-stage">
                    <span class="count">{{ stats.impact_scored }}</span>
                    Impact Scored
                </div>
                <span class="pipeline-arrow">&rarr;</span>
                <div class="pipeline-stage">
                    <span class="count">{{ stats.impact_relevant }}</span>
                    Relevant
                </div>
                <span class="pipeline-arrow">&rarr;</span>
                <div class="pipeline-stage">
                    <span class="count">{{ stats.processed_articles }}</span>
                    NLI Classified
                </div>
                <span class="pipeline-arrow">&rarr;</span>
                <div class="pipeline-stage">
                    <span class="count">{{ stats.company_scanned }}</span>
                    Co. Scanned
                </div>
                <span class="pipeline-arrow">&rarr;</span>
                <div class="pipeline-stage">
                    <span class="count">{{ stats.sent_articles }}</span>
                    Sent
                </div>
            </div>
        </div>

        <!-- Feeds (collapsible, preserved across HTMX swaps) -->
        <details id="feeds-section" class="feeds-section" hx-preserve="true">
            <summary>Feeds ({{ feeds|length }})</summary>
            <div class="feeds-body">
                <form hx-post="/api/feeds" hx-target="#feeds-list" hx-swap="outerHTML"
                      hx-on::after-request="this.reset(); htmx.ajax('GET', '/partials/feeds', '#feeds-list')">
                    <div class="form-row">
                        <input type="url" name="url" placeholder="https://example.com/rss" required>
                        <input type="text" name="name" placeholder="Name (optional)" style="max-width: 200px;">
                        <button type="submit" class="btn btn-primary btn-sm">Add</button>
                    </div>
                </form>
                <div id="feeds-list">
                    {% include "partials/feeds_list.html" %}
                </div>
            </div>
        </details>
    </div>

    <!-- Right column -->
    <div>
        <!-- Workers -->
        <div class="dash-card">
            <h3>Workers</h3>
            {% for name, status in processing.items() %}
            <div class="worker-row">
                <div class="worker-dot {{ 'active' if status.article_id else '' }}"></div>
                <span class="worker-name">{{ name }}</span>
                <span class="worker-activity">
                    {% if status.article_id %}
                        #{{ status.article_id }}
                        <span class="elapsed-timer" data-started="{{ status.started_at }}"></span>
                    {% else %}
                        idle
                    {% endif %}
                </span>
                {% if avg_times.get(name) is not none %}
                <span class="worker-avg">avg {{ avg_times[name] }}s</span>
                {% endif %}
            </div>
            {% endfor %}
        </div>

        <!-- Model Results -->
        {% if stats.per_model %}
        <div class="dash-card">
            <h3>Model Results</h3>
            {% for model, count in stats.per_model.items() %}
            <div class="model-row">
                <span class="kv-label">{{ model }}</span>
                <span class="kv-value">{{ count }}</span>
            </div>
            {% endfor %}
        </div>
        {% endif %}

        <!-- Counts -->
        <div class="dash-card">
            <h3>Counts</h3>
            <div class="kv-row">
                <span class="kv-label">Total Articles</span>
                <span class="kv-value">{{ stats.total_articles }}</span>
            </div>
            <div class="kv-row">
                <span class="kv-label">Feeds</span>
                <span class="kv-value">{{ stats.total_feeds }}</span>
            </div>
            <div class="kv-row">
                <span class="kv-label">Unscored</span>
                <span class="kv-value">{{ stats.impact_unscored }}</span>
            </div>
            <div class="kv-row">
                <span class="kv-label">Company Mentions</span>
                <span class="kv-value">{{ stats.company_mentions }}</span>
            </div>
            <div class="kv-row">
                <span class="kv-label">Sentiment Scored</span>
                <span class="kv-value">{{ stats.company_scored }}</span>
            </div>
        </div>
    </div>
</div>

<!-- Elapsed timer updater -->
<script>
(function() {
    function updateTimers() {
        document.querySelectorAll('.elapsed-timer').forEach(function(el) {
            var started = parseFloat(el.dataset.started);
            if (!started) return;
            var elapsed = Math.floor(Date.now() / 1000 - started);
            if (elapsed < 0) elapsed = 0;
            var m = Math.floor(elapsed / 60);
            var s = elapsed % 60;
            el.textContent = (m > 0 ? m + 'm ' : '') + s + 's';
        });
    }
    updateTimers();
    setInterval(updateTimers, 1000);
})();
</script>
