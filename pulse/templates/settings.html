{% extends "base.html" %}
{% block title %}Settings{% endblock %}
{% block content %}
<h1>Settings</h1>

<div class="card" style="margin-bottom: 1.5rem;">
    <h2>Sentinel Connection</h2>
    <form hx-put="/api/settings/sentinel_url" hx-swap="none"
          hx-on::after-request="document.getElementById('save-status').textContent = 'Saved'; setTimeout(() => document.getElementById('save-status').textContent = '', 2000)">
        <div class="form-row">
            <input type="url" name="url" value="{{ sentinel_url }}" placeholder="http://192.168.1.x:8000">
            <button type="submit" class="btn btn-primary">Save</button>
            <span id="save-status" style="color: var(--green); font-size: 0.85rem;"></span>
        </div>
    </form>
    <p style="color: var(--text-dim); font-size: 0.85rem; margin-top: 0.5rem;">
        Pulse fetches classification labels (geographies and industries) from Sentinel's <code>/api/pulse/labels</code> endpoint.
    </p>
</div>

<div class="card" style="margin-bottom: 1.5rem;">
    <h2>NLI Prompts</h2>
    <p style="color: var(--text-dim); font-size: 0.85rem; margin-bottom: 1rem;">
        These are the hypothesis templates used by the NLI models. Leave blank to use defaults.
    </p>
    <form hx-put="/api/settings/prompts" hx-swap="none"
          hx-on::after-request="document.getElementById('prompt-status').textContent = 'Saved'; setTimeout(() => document.getElementById('prompt-status').textContent = '', 2000)">
        <div style="margin-bottom: 1rem;">
            <label style="display: block; font-size: 0.85rem; color: var(--text-dim); margin-bottom: 0.25rem;">Impact / Relevance</label>
            <input type="text" name="prompt_impact" value="{{ prompt_impact }}" placeholder="This text is about business or economics.">
        </div>
        <div style="margin-bottom: 1rem;">
            <label style="display: block; font-size: 0.85rem; color: var(--text-dim); margin-bottom: 0.25rem;">Country Relevance <code style="font-size: 0.75rem;">{country}</code></label>
            <input type="text" name="prompt_country" value="{{ prompt_country }}" placeholder="This article is about {country}.">
        </div>
        <div style="margin-bottom: 1rem;">
            <label style="display: block; font-size: 0.85rem; color: var(--text-dim); margin-bottom: 0.25rem;">Sector Sentiment <code style="font-size: 0.75rem;">{sector} {country}</code></label>
            <input type="text" name="prompt_sentiment" value="{{ prompt_sentiment }}" placeholder="This is good news for the {sector} sector in {country}.">
        </div>
        <div style="margin-bottom: 1rem;">
            <label style="display: block; font-size: 0.85rem; color: var(--text-dim); margin-bottom: 0.25rem;">Company Sentiment <code style="font-size: 0.75rem;">{company}</code></label>
            <input type="text" name="prompt_company" value="{{ prompt_company }}" placeholder="This is good news for {company}.">
        </div>
        <div class="form-row">
            <button type="submit" class="btn btn-primary">Save Prompts</button>
            <span id="prompt-status" style="color: var(--green); font-size: 0.85rem;"></span>
        </div>
    </form>
</div>

<div class="card" id="fundus-card">
    <h2>Fundus Publishers</h2>
    <p style="color: var(--text-dim); font-size: 0.85rem; margin-bottom: 1rem;">
        Select news publishers to crawl via <a href="https://github.com/flairNLP/fundus" target="_blank">fundus</a>. Articles are fetched every 10 minutes.
    </p>
    <div id="fundus-publishers" style="margin-bottom: 1rem;">
        <p style="color: var(--text-dim); font-size: 0.85rem;">Loading publishers...</p>
    </div>
    <div class="form-row">
        <button class="btn btn-primary" onclick="saveFundusPublishers()">Save</button>
        <button class="btn btn-primary" onclick="triggerFundusCrawl(this)" style="background: var(--green);">Crawl Now</button>
        <span id="fundus-status" style="color: var(--green); font-size: 0.85rem;"></span>
    </div>
</div>

<style>
    .fundus-country { margin-bottom: 0.25rem; }
    .fundus-country-header {
        cursor: pointer;
        display: flex;
        align-items: center;
        gap: 0.5rem;
        padding: 0.4rem 0.5rem;
        border-radius: 4px;
        font-size: 0.9rem;
        font-weight: 600;
        user-select: none;
    }
    .fundus-country-header:hover { background: rgba(99, 102, 241, 0.08); }
    .fundus-country-header .arrow {
        font-size: 0.7rem;
        transition: transform 0.15s;
        color: var(--text-dim);
    }
    .fundus-country-header .arrow.open { transform: rotate(90deg); }
    .fundus-country-header .count {
        font-size: 0.75rem;
        color: var(--text-dim);
        font-weight: 400;
    }
    .fundus-publishers-list {
        display: none;
        padding: 0.25rem 0 0.5rem 1.5rem;
    }
    .fundus-publishers-list.open { display: block; }
    .fundus-pub-row {
        display: flex;
        align-items: center;
        gap: 0.5rem;
        padding: 0.2rem 0;
        font-size: 0.85rem;
    }
    .fundus-pub-row input[type="checkbox"] {
        accent-color: var(--accent);
        width: 14px;
        height: 14px;
    }
    .fundus-pub-row .domain {
        color: var(--text-dim);
        font-size: 0.75rem;
    }
</style>

<script>
(function() {
    fetch('/api/fundus/publishers')
        .then(r => r.json())
        .then(data => {
            const container = document.getElementById('fundus-publishers');
            const countries = Object.keys(data).sort();
            if (!countries.length) {
                container.innerHTML = '<p style="color:var(--text-dim)">No publishers available.</p>';
                return;
            }
            let html = '';
            for (const country of countries) {
                const pubs = data[country];
                const enabledCount = pubs.filter(p => p.enabled).length;
                const countLabel = enabledCount > 0
                    ? `${enabledCount}/${pubs.length} enabled`
                    : `${pubs.length}`;
                html += `<div class="fundus-country">`;
                html += `<div class="fundus-country-header" onclick="toggleCountry(this)">`;
                html += `<span class="arrow">&#9654;</span>`;
                html += `<span>${country.toUpperCase()}</span>`;
                html += `<span class="count">(${countLabel})</span>`;
                html += `</div>`;
                html += `<div class="fundus-publishers-list">`;
                for (const pub of pubs) {
                    html += `<label class="fundus-pub-row">`;
                    html += `<input type="checkbox" value="${pub.id}" ${pub.enabled ? 'checked' : ''}>`;
                    html += `<span>${pub.name}</span>`;
                    html += `<span class="domain">${pub.domain}</span>`;
                    html += `</label>`;
                }
                html += `</div></div>`;
            }
            container.innerHTML = html;
        })
        .catch(() => {
            document.getElementById('fundus-publishers').innerHTML =
                '<p style="color:var(--red)">Failed to load publishers.</p>';
        });
})();

function toggleCountry(header) {
    const arrow = header.querySelector('.arrow');
    const list = header.nextElementSibling;
    arrow.classList.toggle('open');
    list.classList.toggle('open');
}

function saveFundusPublishers() {
    const checks = document.querySelectorAll('#fundus-publishers input[type="checkbox"]:checked');
    const ids = Array.from(checks).map(c => c.value);
    fetch('/api/fundus/publishers', {
        method: 'PUT',
        headers: {'Content-Type': 'application/json'},
        body: JSON.stringify({publishers: ids})
    }).then(r => r.json()).then(() => {
        const el = document.getElementById('fundus-status');
        el.textContent = 'Saved';
        setTimeout(() => el.textContent = '', 2000);
    });
}

function triggerFundusCrawl(btn) {
    btn.disabled = true;
    btn.textContent = 'Crawling...';
    fetch('/api/fundus/crawl', {method: 'POST'})
        .then(r => r.json())
        .then(data => {
            const el = document.getElementById('fundus-status');
            el.textContent = `Crawl complete: ${data.added} new articles`;
            setTimeout(() => el.textContent = '', 5000);
        })
        .catch(() => {
            document.getElementById('fundus-status').textContent = 'Crawl failed';
        })
        .finally(() => {
            btn.disabled = false;
            btn.textContent = 'Crawl Now';
        });
}
</script>
{% endblock %}
