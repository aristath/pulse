<!-- Row 1: Health Bar -->
<div class="health-bar">
    <div id="health-dots" class="health-dots">
        {% for name, status in processing.items() %}
        <div class="health-dot {{ 'active' if status.article_id else '' }}" title="{{ worker_labels.get(name, name) }}"{% if status.started_at %} data-started="{{ status.started_at }}"{% endif %}>
            <div class="tooltip">
                <strong>{{ worker_labels.get(name, name) }}</strong>
                {% if avg_times.get(name) is not none %}<br>avg {{ avg_times[name] }}s{% endif %}
            </div>
        </div>
        {% endfor %}
    </div>
    <div class="health-stats">
        <span class="health-stat">Queue <strong id="hs-queue">{{ stats.impact_unscored }}</strong></span>
        <span class="health-stat">Relevant <strong id="hs-relevant">{{ stats.impact_relevant }}</strong></span>
        <span class="health-stat">Mentions <strong id="hs-mentions">{{ stats.company_mentions }}</strong></span>
        <span class="health-stat">Sent <strong id="hs-sent">{{ stats.sent_articles }}</strong></span>
    </div>
</div>

<!-- Row 2: Two columns -->
<div class="dash-columns">
    <!-- Left column -->
    <div>
        <!-- Pipeline Flow -->
        <div class="dash-card">
            <h3>Pipeline Flow</h3>
            <div class="pipeline-grid">
                <div class="pg-cell">
                    <span class="count" id="ps-ingested">{{ stats.total_articles }}</span>
                    Ingested
                </div>
                <div class="pg-cell">
                    <span class="count" id="ps-impact">{{ stats.impact_scored }}</span>
                    Impact Scored
                </div>
                <div class="pg-cell">
                    <span class="count" id="ps-relevant">{{ stats.impact_relevant }}</span>
                    Relevant
                </div>
                <div class="pg-cell">
                    <span class="count" id="ps-classified">{{ stats.processed_articles }}</span>
                    NLI Classified
                </div>
                <div class="pg-cell">
                    <span class="count" id="ps-filtered">{{ stats.impact_filtered }}</span>
                    Filtered
                </div>
                <div class="pg-cell">
                    <span class="count" id="ps-scanned">{{ stats.company_scanned }}</span>
                    Co. Scanned
                </div>
                <div class="pg-cell">
                    <span class="count" id="ps-sent">{{ stats.sent_articles }}</span>
                    Sent
                </div>
                <div class="pg-pending">
                    <span class="count" id="pp-pruned">{{ stats.pruned_articles }}</span>
                    pruned
                </div>
                <div class="pg-pending">
                    <span class="count" id="pp-impact">{{ stats.impact_unscored }}</span>
                    pending
                </div>
                <div class="pg-pending">&nbsp;</div>
                <div class="pg-pending">
                    <span class="count" id="pp-classified">{{ stats.impact_relevant - stats.processed_articles }}</span>
                    pending
                </div>
                <div class="pg-pending">&nbsp;</div>
                <div class="pg-pending">
                    <span class="count" id="pp-scanned">{{ stats.scan_eligible - stats.company_scanned }}</span>
                    pending
                </div>
                <div class="pg-pending">&nbsp;</div>
            </div>
        </div>

        <!-- Charts (preserved across HTMX swaps) -->
        <div id="charts-card" class="dash-card">
            <h3>Sentiment by Company</h3>
            <div id="chart-company-bars" class="sentiment-bars"></div>

            <h3 style="margin-top:1.5rem;">Sentiment by Country</h3>
            <div id="chart-country-bars" class="sentiment-bars"></div>

            <h3 style="margin-top:1.5rem;">Sentiment by Industry</h3>
            <div id="chart-industry-bars" class="sentiment-bars"></div>

            <h3 style="margin-top:1.5rem;">Industries by Country</h3>
            <div id="chart-industries-by-country"></div>

            <h3 style="margin-top:1.5rem;">Countries by Industry</h3>
            <div id="chart-countries-by-industry"></div>
        </div>

        <!-- Feeds -->
        <details id="feeds-section" class="collapsible-section">
            <summary>Feeds ({{ feeds|length }})</summary>
            <div class="collapsible-body">
                <form hx-post="/api/feeds" hx-target="#feeds-list" hx-swap="outerHTML"
                      hx-on::after-request="this.reset(); htmx.ajax('GET', '/partials/feeds', '#feeds-list')">
                    <div class="form-row">
                        <input type="url" name="url" placeholder="https://example.com/rss" required>
                        <input type="text" name="name" placeholder="Name (optional)" style="max-width: 200px;">
                        <button type="submit" class="btn btn-primary btn-sm">Add</button>
                    </div>
                </form>
                <div id="feeds-list">
                    {% include "partials/feeds_list.html" %}
                </div>
            </div>
        </details>

        <!-- Settings (collapsible, preserved across HTMX swaps) -->
        <details id="settings-section" class="collapsible-section">
            <summary>Settings</summary>
            <div class="collapsible-body">
                <div class="settings-group">
                    <h4>Sentinel Connection</h4>
                    <form hx-put="/api/settings/sentinel_url" hx-swap="none"
                          hx-on::after-request="document.getElementById('save-status').textContent = 'Saved'; setTimeout(() => document.getElementById('save-status').textContent = '', 2000)">
                        <div class="form-row">
                            <input type="url" name="url" value="{{ sentinel_url }}" placeholder="http://192.168.1.x:8000">
                            <button type="submit" class="btn btn-primary btn-sm">Save</button>
                            <span id="save-status" style="color: var(--green); font-size: 0.8rem;"></span>
                        </div>
                    </form>
                </div>

                <div class="settings-group">
                    <h4>Memory Window</h4>
                    <form hx-put="/api/settings/memory" hx-swap="none"
                          hx-on::after-request="document.getElementById('memory-status').textContent = 'Saved'; setTimeout(() => document.getElementById('memory-status').textContent = '', 2000)">
                        <div class="settings-field">
                            <label>Max Memory (days)</label>
                            <input type="number" name="max_memory_days" value="{{ max_memory_days }}" min="1" max="120" step="1" style="max-width:100px;">
                        </div>
                        <div class="form-row">
                            <button type="submit" class="btn btn-primary btn-sm">Save Memory</button>
                            <span id="memory-status" style="color: var(--green); font-size: 0.8rem;"></span>
                        </div>
                    </form>
                </div>

                <div class="settings-group">
                    <h4>NLI Prompts</h4>
                    <form hx-put="/api/settings/prompts" hx-swap="none"
                          hx-on::after-request="document.getElementById('prompt-status').textContent = 'Saved'; setTimeout(() => document.getElementById('prompt-status').textContent = '', 2000)">
                        <div class="settings-field">
                            <label>Impact / Relevance</label>
                            <input type="text" name="prompt_impact" value="{{ prompt_impact }}" placeholder="This text is about business or economics.">
                        </div>
                        <div class="settings-field">
                            <label>Country Relevance <code>{country}</code></label>
                            <input type="text" name="prompt_country" value="{{ prompt_country }}" placeholder="This text is relevant to {country}.">
                        </div>
                        <div class="settings-field">
                            <label>Sector Relevance <code>{sector} {country}</code></label>
                            <input type="text" name="prompt_sector" value="{{ prompt_sector }}" placeholder="This text is about the {sector} sector in {country}.">
                        </div>
                        <div class="settings-field">
                            <label>Sector Sentiment <code>{sector} {country}</code></label>
                            <input type="text" name="prompt_sentiment" value="{{ prompt_sentiment }}" placeholder="This is good news for the {sector} sector in {country}.">
                        </div>
                        <div class="settings-field">
                            <label>Company Sentiment <code>{company}</code></label>
                            <input type="text" name="prompt_company" value="{{ prompt_company }}" placeholder="This is good news for {company}.">
                        </div>
                        <div class="form-row">
                            <button type="submit" class="btn btn-primary btn-sm">Save Prompts</button>
                            <span id="prompt-status" style="color: var(--green); font-size: 0.8rem;"></span>
                        </div>
                    </form>
                </div>

                <div class="settings-group">
                    <h4>Thresholds</h4>
                    <form hx-put="/api/settings/thresholds" hx-swap="none"
                          hx-on::after-request="document.getElementById('threshold-status').textContent = 'Saved'; setTimeout(() => document.getElementById('threshold-status').textContent = '', 2000)">
                        <div class="settings-field">
                            <label>Classify (impact &ge;)</label>
                            <input type="number" name="classify_threshold" value="{{ classify_threshold }}" placeholder="0.5" step="0.01" min="0" max="1" style="max-width:100px;">
                        </div>
                        <div class="settings-field">
                            <label>Company Scanner (impact &ge;)</label>
                            <input type="number" name="scan_threshold" value="{{ scan_threshold }}" placeholder="0.3" step="0.01" min="0" max="1" style="max-width:100px;">
                        </div>
                        <div class="settings-field">
                            <label>Validate Company (entailment &ge;)</label>
                            <input type="number" name="validate_threshold" value="{{ validate_threshold }}" placeholder="0.5" step="0.01" min="0" max="1" style="max-width:100px;">
                        </div>
                        <div class="form-row">
                            <button type="submit" class="btn btn-primary btn-sm">Save Thresholds</button>
                            <span id="threshold-status" style="color: var(--green); font-size: 0.8rem;"></span>
                        </div>
                    </form>
                </div>

                <div class="settings-group">
                    <details>
                        <summary>Fundus Publishers</summary>
                        <div id="fundus-publishers" style="margin-top: 0.5rem;">
                            <p style="color: var(--text-dim); font-size: 0.8rem;">Loading publishers...</p>
                        </div>
                    </details>
                    <div class="form-row" style="margin-top: 0.5rem;">
                        <button class="btn btn-primary btn-sm" onclick="saveFundusPublishers()">Save</button>
                        <button class="btn btn-sm" style="background: var(--green); color: white;" onclick="triggerFundusCrawl(this)">Crawl Now</button>
                        <span id="fundus-status" style="color: var(--green); font-size: 0.8rem;"></span>
                    </div>
                </div>
            </div>
        </details>
    </div>

    <!-- Right column -->
    <div>
        <!-- Workers -->
        <div class="dash-card">
            <h3>Workers</h3>
            <div id="worker-rows">
            {% for name, status in processing.items() %}
            <div class="worker-row">
                <div class="worker-dot {{ 'active' if status.article_id else '' }}"{% if status.started_at %} data-started="{{ status.started_at }}"{% endif %}></div>
                <span class="worker-name">{{ worker_labels.get(name, name) }}</span>
                <span class="worker-activity">
                    {% if status.article_id %}
                        #{{ status.article_id }}
                        <span class="elapsed-timer" data-started="{{ status.started_at }}"></span>
                    {% else %}
                        idle
                    {% endif %}
                </span>
                {% if avg_times.get(name) is not none %}
                <span class="worker-avg">avg {{ avg_times[name] }}s</span>
                {% endif %}
            </div>
            {% endfor %}
            </div>
        </div>

        <!-- Top Impactful News -->
        <div class="dash-card">
            <h3>Latest Impactful News</h3>
            <div class="top-articles">
            {% for article in top_articles %}
                <a href="{{ article.url }}" target="_blank" class="top-article-row" title="{{ article.title }}">
                    <span class="top-article-title">{{ article.title }}</span>
                    <span class="top-article-impact">{{ "%.0f"|format(article.impact * 100) }}%</span>
                </a>
            {% else %}
                <p style="color: var(--text-dim); font-size: 0.8rem;">No impactful articles yet.</p>
            {% endfor %}
            </div>
        </div>

    </div>
</div>

<!-- Elapsed timer updater + settings JS -->
<script>
(function() {
    function updateTimers() {
        document.querySelectorAll('.elapsed-timer').forEach(function(el) {
            var started = parseFloat(el.dataset.started);
            if (!started) return;
            var elapsed = Math.floor(Date.now() / 1000 - started);
            if (elapsed < 0) elapsed = 0;
            var m = Math.floor(elapsed / 60);
            var s = elapsed % 60;
            el.textContent = (m > 0 ? m + 'm ' : '') + s + 's';
        });
    }
    updateTimers();
    setInterval(updateTimers, 1000);

    // Offset blink animation so each dot starts from its job start time
    document.querySelectorAll('.health-dot[data-started], .worker-dot[data-started]').forEach(function(el) {
        var started = parseFloat(el.dataset.started);
        if (!started) return;
        var elapsed = (Date.now() / 1000 - started) % 0.25;
        el.style.animationDelay = '-' + elapsed.toFixed(3) + 's';
    });

    // Sentiment bar charts (plain CSS)
    if (!window._chartsInited) {
        window._chartsInited = true;

        function barRowHtml(d, barType) {
            var v = d.avg_sentiment;
            var pct = Math.abs(v) * 50;
            var color = v >= 0 ? '#22c55e' : '#ef4444';
            var left = v >= 0 ? '50%' : (50 - pct) + '%';
            return '<div class="sbar-row" data-type="' + barType + '" data-label="' + d.label.replace(/"/g, '&quot;') + '"'
                + ' title="' + d.label + ': ' + v.toFixed(4) + ' (' + d.article_count + ' articles)">'
                + '<span class="sbar-label">' + d.label + '</span>'
                + '<div class="sbar-track"><div class="sbar-zero"></div>'
                + '<div class="sbar-fill" style="left:' + left + ';width:' + pct + '%;background:' + color + '"></div></div>'
                + '<span class="sbar-val">' + v.toFixed(3) + '</span>'
                + '</div>';
        }

        function renderBarChart(container, data, barType) {
            var html = '';
            for (var i = 0; i < data.length; i++) html += barRowHtml(data[i], barType);
            container.innerHTML = html || '<span style="color:#8888a0;font-size:0.8rem">No data</span>';
        }

        function renderGroupedCharts(container, data, groupKey, labelKey) {
            var barType = labelKey === 'industry' ? 'industry' : 'country';
            var groups = {};
            for (var i = 0; i < data.length; i++) {
                var d = data[i];
                var g = d[groupKey];
                if (!groups[g]) groups[g] = [];
                groups[g].push({label: d[labelKey], avg_sentiment: d.avg_sentiment, article_count: d.article_count});
            }
            var html = '';
            var keys = Object.keys(groups).sort();
            for (var k = 0; k < keys.length; k++) {
                var items = groups[keys[k]];
                items.sort(function(a, b) { return b.avg_sentiment - a.avg_sentiment; });
                html += '<div class="sbar-group-label">' + keys[k] + '</div>';
                for (var j = 0; j < items.length; j++) html += barRowHtml(items[j], barType);
            }
            container.innerHTML = html || '<span style="color:#8888a0;font-size:0.8rem">No data</span>';
        }

        function openArticleModal(barType, label) {
            var modal = document.getElementById('article-modal');
            document.getElementById('modal-title').textContent = label + ' (' + barType + ')';
            document.getElementById('modal-body').innerHTML = '<span style="color:#8888a0">Loading...</span>';
            modal.style.display = 'flex';
            fetch('/api/charts/sentiment-bar-articles?type=' + encodeURIComponent(barType) + '&label=' + encodeURIComponent(label))
                .then(function(r) { return r.json(); })
                .then(function(articles) {
                    if (!articles.length) {
                        document.getElementById('modal-body').innerHTML = '<span style="color:#8888a0">No articles found.</span>';
                        return;
                    }
                    var html = '';
                    for (var i = 0; i < articles.length; i++) {
                        var a = articles[i];
                        var sColor = a.sentiment >= 0 ? '#22c55e' : '#ef4444';
                        html += '<div class="modal-article">'
                            + '<a href="' + a.url + '" target="_blank" rel="noopener">' + (a.title || a.url) + '</a>'
                            + '<span class="modal-meta">'
                            + '<span style="color:' + sColor + '">' + a.sentiment.toFixed(3) + '</span>'
                            + ' &middot; wt ' + a.weight
                            + '</span></div>';
                    }
                    document.getElementById('modal-body').innerHTML = html;
                })
                .catch(function() {
                    document.getElementById('modal-body').innerHTML = '<span style="color:#ef4444">Failed to load.</span>';
                });
        }

        document.getElementById('charts-card').addEventListener('click', function(e) {
            var row = e.target.closest('.sbar-row');
            if (!row) return;
            openArticleModal(row.dataset.type, row.dataset.label);
        });

        function refreshBarCharts() {
            Promise.all([
                fetch('/api/charts/sentiment-bars?type=country').then(function(r) { return r.json(); }),
                fetch('/api/charts/sentiment-bars?type=industry').then(function(r) { return r.json(); }),
                fetch('/api/charts/sentiment-bars?type=company').then(function(r) { return r.json(); }),
                fetch('/api/charts/sentiment-bars?type=detailed').then(function(r) { return r.json(); })
            ]).then(function(results) {
                renderBarChart(document.getElementById('chart-country-bars'), results[0], 'country');
                renderBarChart(document.getElementById('chart-industry-bars'), results[1], 'industry');
                renderBarChart(document.getElementById('chart-company-bars'), results[2], 'company');
                renderGroupedCharts(document.getElementById('chart-industries-by-country'), results[3], 'country', 'industry');
                renderGroupedCharts(document.getElementById('chart-countries-by-industry'), results[3], 'industry', 'country');
            }).catch(function(e) { console.error('Bar chart refresh failed:', e); });
        }

        refreshBarCharts();
        setInterval(refreshBarCharts, 30000);
    }

    // Load fundus publishers (only if container exists and empty)
    var fp = document.getElementById('fundus-publishers');
    if (fp && !fp.dataset.loaded) {
        fp.dataset.loaded = '1';
        fetch('/api/fundus/publishers')
            .then(function(r) { return r.json(); })
            .then(function(data) {
                var countries = Object.keys(data).sort();
                if (!countries.length) {
                    fp.innerHTML = '<p style="color:var(--text-dim);font-size:0.8rem">No publishers available.</p>';
                    return;
                }
                var html = '';
                for (var i = 0; i < countries.length; i++) {
                    var country = countries[i];
                    var pubs = data[country];
                    var enabled = pubs.filter(function(p) { return p.enabled; }).length;
                    var countLabel = enabled > 0 ? enabled + '/' + pubs.length + ' enabled' : '' + pubs.length;
                    html += '<div class="fundus-country">';
                    html += '<div class="fundus-country-header" onclick="toggleCountry(this)">';
                    html += '<span class="arrow">&#9654;</span>';
                    html += '<span>' + country.toUpperCase() + '</span>';
                    html += '<span class="count">(' + countLabel + ')</span>';
                    html += '</div>';
                    html += '<div class="fundus-publishers-list">';
                    for (var j = 0; j < pubs.length; j++) {
                        var pub = pubs[j];
                        html += '<label class="fundus-pub-row">';
                        html += '<input type="checkbox" value="' + pub.id + '"' + (pub.enabled ? ' checked' : '') + '>';
                        html += '<span>' + pub.name + '</span>';
                        html += '<span class="domain">' + pub.domain + '</span>';
                        html += '</label>';
                    }
                    html += '</div></div>';
                }
                fp.innerHTML = html;
            })
            .catch(function() {
                fp.innerHTML = '<p style="color:var(--red);font-size:0.8rem">Failed to load publishers.</p>';
            });
    }
})();

function toggleCountry(header) {
    var arrow = header.querySelector('.arrow');
    var list = header.nextElementSibling;
    arrow.classList.toggle('open');
    list.classList.toggle('open');
}

function saveFundusPublishers() {
    var checks = document.querySelectorAll('#fundus-publishers input[type="checkbox"]:checked');
    var ids = Array.from(checks).map(function(c) { return c.value; });
    fetch('/api/fundus/publishers', {
        method: 'PUT',
        headers: {'Content-Type': 'application/json'},
        body: JSON.stringify({publishers: ids})
    }).then(function(r) { return r.json(); }).then(function() {
        var el = document.getElementById('fundus-status');
        el.textContent = 'Saved';
        setTimeout(function() { el.textContent = ''; }, 2000);
    });
}

function triggerFundusCrawl(btn) {
    btn.disabled = true;
    btn.textContent = 'Crawling...';
    fetch('/api/fundus/crawl', {method: 'POST'})
        .then(function(r) { return r.json(); })
        .then(function(data) {
            var el = document.getElementById('fundus-status');
            el.textContent = 'Done: ' + data.added + ' new';
            setTimeout(function() { el.textContent = ''; }, 5000);
        })
        .catch(function() {
            document.getElementById('fundus-status').textContent = 'Failed';
        })
        .finally(function() {
            btn.disabled = false;
            btn.textContent = 'Crawl Now';
        });
}

// --- SSE live updates (targeted DOM patching) ---
(function() {
    if (window._sseConnected) return;
    window._sseConnected = true;

    var src = new EventSource('/api/events');
    src.addEventListener('update', function(e) {
        var d = JSON.parse(e.data);
        var s = d.stats, proc = d.processing, avg = d.avg_times, labels = d.worker_labels || {};

        // Health stats
        var hs = {queue: s.impact_unscored, relevant: s.impact_relevant, mentions: s.company_mentions, sent: s.sent_articles};
        for (var k in hs) { var el = document.getElementById('hs-' + k); if (el) el.textContent = hs[k]; }

        // Pipeline
        var ps = {ingested: s.total_articles, impact: s.impact_scored, relevant: s.impact_relevant, classified: s.processed_articles, filtered: s.impact_filtered, scanned: s.company_scanned, sent: s.sent_articles};
        for (var k in ps) { var el = document.getElementById('ps-' + k); if (el) el.textContent = ps[k]; }
        var pp = {pruned: s.pruned_articles, impact: s.impact_unscored, classified: s.impact_relevant - s.processed_articles, scanned: s.scan_eligible - s.company_scanned};
        for (var k in pp) { var el = document.getElementById('pp-' + k); if (el) el.textContent = pp[k]; }

        // Health dots
        var dotsEl = document.getElementById('health-dots');
        if (dotsEl) {
            var dhtml = '';
            for (var name in proc) {
                var st = proc[name];
                var active = st.article_id ? ' active' : '';
                var ds = st.started_at ? ' data-started="' + st.started_at + '"' : '';
                var lbl = labels[name] || name;
                var avgStr = avg[name] != null ? '<br>avg ' + avg[name] + 's' : '';
                dhtml += '<div class="health-dot' + active + '" title="' + lbl + '"' + ds + '>'
                    + '<div class="tooltip"><strong>' + lbl + '</strong>' + avgStr + '</div></div>';
            }
            dotsEl.innerHTML = dhtml;
        }

        // Worker rows
        var wEl = document.getElementById('worker-rows');
        if (wEl) {
            var whtml = '';
            for (var name in proc) {
                var st = proc[name];
                var active = st.article_id ? ' active' : '';
                var ds = st.started_at ? ' data-started="' + st.started_at + '"' : '';
                var lbl = labels[name] || name;
                var activity = st.article_id
                    ? '#' + st.article_id + ' <span class="elapsed-timer" data-started="' + st.started_at + '"></span>'
                    : 'idle';
                var avgStr = avg[name] != null ? '<span class="worker-avg">avg ' + avg[name] + 's</span>' : '';
                whtml += '<div class="worker-row">'
                    + '<div class="worker-dot' + active + '"' + ds + '></div>'
                    + '<span class="worker-name">' + lbl + '</span>'
                    + '<span class="worker-activity">' + activity + '</span>'
                    + avgStr + '</div>';
            }
            wEl.innerHTML = whtml;
        }
    });
})();
</script>
